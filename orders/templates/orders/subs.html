{% extends "orders/base.html" %}

{% block title %}Our Subs{% endblock %}
{% load static %}

{% block body %}
  <h1>Our Subs</h1>
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-10">
        <table class="table">
          <tr>
            <th></th>
            <th>Small</th>
            <th>Large</th>
            <th>Extra<br>Cheese</th>
          </tr>
          {% for element in subs %}
          <tr>
            <td>{{ element.sub }}</td>
            <td>{{ element.small }}&nbsp&nbsp{% if user.is_authenticated %}{% csrf_token %}<button data-dish="{{ element.sub }}" data-type="" data-size="Small" data-price="{{ element.small }}" type="button" class="btn btn-secondary btn-sm subs">Add Cart</button>{% endif %}</td>
            <td>{{ element.large }}&nbsp&nbsp{% if user.is_authenticated %}{% csrf_token %}<button data-dish="{{ element.sub }}" data-type="" data-size="Large" data-price="{{ element.large }}" type="button" class="btn btn-secondary btn-sm subs">Add Cart</button>{% endif %}</td>
            <td><input type="checkbox" name="cheese" class="form-check-label cheese"></td>
          </tr>
          {% endfor %}
        </table>
        <!-- Modal -->
        <div class="modal fade" id="addAdditions" tabindex="-1" role="dialog" aria-labelledby="Add Toppings to Your Pizza" aria-hidden="true">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">It's Time for Extras!</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <p>Optionally add some of these additions to my Steak</p>
                  <div class="form-group col-8">

                      <input id="nothing" class="checkboxes" data-add=""type="checkbox" value="no_addition">&nbspI don't want any addition<br>
                      <input class="checkboxes anything" data-add="0.50" type="checkbox" value="Mushrooms">&nbspMushrooms<br>
                      <input class="checkboxes anything" data-add="0.50" type="checkbox" value="Green Peppers">&nbspGreen Peppers<br>
                      <input class="checkboxes anything" data-add="0.50" type="checkbox" value="Onions">&nbspOnions

                  </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" id="cancel">Close</button>
                <button type="button" class="btn btn-primary" id="addToCart">Add to Cart</button>
              </div>
            </div>
          </div>
        </div>
        <script>
        document.addEventListener("DOMContentLoaded", () => {

          let nothing = document.querySelector('#nothing');

          nothing.addEventListener('change', () => {
            let anythings = document.querySelectorAll('.anything');

            anythings.forEach(anything => {
              if (anything.disabled) {
                anything.removeAttribute("disabled");
              }else{
                anything.checked = false;
                anything.setAttribute("disabled", "disabled");
              }
            });
          });


          let buttons = document.querySelectorAll('.subs');

          buttons.forEach(button => {
            if (button.parentNode.parentNode.childNodes[1].innerHTML == 'Steak + Cheese') {
              let steak = button;
              steak.setAttribute('data-toggle', 'modal');
              steak.setAttribute('data-target', '#addAdditions');

            }
            button.onclick = function() {
              let crsf = this.previousSibling.value;
              let pre_cheese = this.parentNode.parentNode;
              let cheese = pre_cheese.querySelector('.cheese');


              let request = new XMLHttpRequest;
              let data = new FormData();
              data.append("dish", this.dataset.dish);
              data.append("type", this.dataset.type);
              data.append("size", this.dataset.size);

              let price = parseFloat(this.dataset.price);



              request.open('POST', '/added');
              request.setRequestHeader('X-CSRFToken', crsf);

              if (typeof cheese.checked !== 'undefined'){
                if (cheese.checked == true) {
                  data.append("extra_cheese", true)
                  price += 0.50;
                }
              }

              if (button.parentNode.parentNode.childNodes[1].innerHTML == 'Steak + Cheese') {
                document.querySelector('#addToCart').onclick = function() {

                  if (document.querySelector('#nothing').checked == false) {

                    let checkboxes = document.querySelectorAll('.checkboxes');
                    let counter = 0;
                    checkboxes.forEach(checkbox => {
                      if (checkbox.checked) {
                        data.append("checkbox" + counter, checkbox.value);
                        counter++;
                        price += 0.50
                      }
                    })

                      request.open('POST', '/added');
                      request.setRequestHeader('X-CSRFToken', crsf);
                      data.append("price", price.toFixed(2));
                      request.send(data);
                      document.querySelector('#cancel').click();

                      request.onload = () => {
                        let data = JSON.parse(request.responseText);
                        document.querySelector('#cart').src = "/static/orders/img/Shopping-Cart-icon-active.png";

                        console.log(data);
                      }

                  }else{

                    request.open('POST', '/added');
                    request.setRequestHeader('X-CSRFToken', crsf);
                    data.append("price", price.toFixed(2));
                    request.send(data);
                    document.querySelector('#cancel').click();

                    request.onload = () => {
                      let data = JSON.parse(request.responseText);
                      document.querySelector('#cart').src = "/static/orders/img/Shopping-Cart-icon-active.png";

                      console.log(data);
                    }
                  }
                }
              }else{
                data.append("price", price.toFixed(2));
                request.send(data);

                request.onload = () => {
                  let data = JSON.parse(request.responseText);
                  document.querySelector('#cart').src = "/static/orders/img/Shopping-Cart-icon-active.png";


                  console.log(data);
                }
              }
            }
          });
        });
        </script>
        <h5>Some Extras</h5>
        <table class="table">
          <tr>
            <th></th>
            <th>Price</td>
          <tr>
            <td>Extra Cheese in All Subs</td>
            <td>+0.50</td>
          </tr>
          <tr>
            <td>Mushrooms <span style="font-size:0.8em; color: gray;"> - Just for Steaks - </span></td>
            <td>+0.50</td>
          </tr>
          <tr>
            <td>Green Peppers  <span style="font-size:0.8em; color: gray;"> - Just for Steaks - </span></td>
            <td>+0.50</td>
          </tr>
          <tr>
            <td>Onions  <span style="font-size:0.8em; color: gray;"> - Just for Steaks - </span></td>
            <td>+0.50</td>
          </tr>
        </table>
      </div>
    </div>
  </div>
{% endblock %}
